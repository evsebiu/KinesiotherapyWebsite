<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PhysioVanu Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --sidebar-width: 260px;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light); color: var(--dark); overflow-x: hidden; }

        /* Sidebar & Nav */
        .sidebar { width: var(--sidebar-width); background: #ffffff; border-right: 1px solid #e2e8f0; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .brand-box { height: 70px; display: flex; align-items: center; padding: 0 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .nav-link { color: #64748b; padding: 0.85rem 1.5rem; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover { color: var(--primary); background: #f1f5f9; }
        .nav-link.active { color: var(--primary); background: #eef2ff; border-left-color: var(--primary); }
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; transition: margin-left 0.3s ease; }

        /* Components */
        .card-stat { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); height: 100%; transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-icon-wrapper { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; margin-bottom: 1rem; }
        .chart-container { background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid #e2e8f0; height: 100%; min-height: 350px; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; color: transparent !important; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white border-bottom d-lg-none sticky-top px-3">
    <a class="navbar-brand fw-bold text-primary" href="#"><i class="fas fa-spa me-2"></i>PhysioVanu</a>
    <button class="btn btn-light" id="sidebarToggle"><i class="fas fa-bars"></i></button>
</nav>

<aside class="sidebar" id="sidebar" th:fragment="sidebar(currentPage)">
    <div class="brand-box">
        <h4 class="m-0 fw-bold text-dark"><i class="fas fa-spa text-primary me-2"></i>PhysioVanu</h4>
    </div>

    <div class="d-flex flex-column h-100 justify-content-between pb-3">
        <ul class="nav flex-column mt-4">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentPage == 'dashboard' ? 'active' : ''}" href="/admin/dashboard">
                    <i class="fas fa-chart-pie w-25"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentPage == 'appointments' ? 'active' : ''}" href="/admin/appointments">
                    <i class="fas fa-calendar-check w-25"></i> Programări
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentPage == 'services' ? 'active' : ''}" href="/admin/services">
                    <i class="fas fa-hand-holding-medical w-25"></i> Servicii
                </a>
            </li>
        </ul>

        <div class="px-3">
            <div class="p-3 bg-light rounded-3 border">
                <small class="text-muted d-block mb-2">Logat ca Admin</small>
                <a href="/logout" class="btn btn-outline-danger btn-sm w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>Deconectare
                </a>
            </div>
        </div>
    </div>
</aside>

<main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Dashboard</h2>
            <p class="text-muted mb-0" id="currentDate">...</p>
        </div>
        <button class="btn btn-white border shadow-sm" onclick="DashboardApp.refreshData()"><i class="fas fa-sync-alt me-2 text-primary"></i>Refresh</button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card-stat">
                <div class="stat-icon-wrapper bg-primary bg-opacity-10 text-primary"><i class="fas fa-calendar-check"></i></div>
                <h6 class="text-muted mb-1">Total Programări</h6>
                <h3 class="fw-bold mb-0 skeleton-text" id="statTotal">...</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-stat">
                <div class="stat-icon-wrapper bg-success bg-opacity-10 text-success"><i class="fas fa-wallet"></i></div>
                <h6 class="text-muted mb-1">Venit Estimat</h6>
                <h3 class="fw-bold mb-0 skeleton-text" id="statRevenue">...</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-stat">
                <div class="stat-icon-wrapper bg-warning bg-opacity-10 text-warning"><i class="fas fa-briefcase-medical"></i></div>
                <h6 class="text-muted mb-1">Servicii Active</h6>
                <h3 class="fw-bold mb-0 skeleton-text" id="statServices">...</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-stat">
                <div class="stat-icon-wrapper bg-secondary bg-opacity-10 text-secondary"><i class="fas fa-percentage"></i></div>
                <h6 class="text-muted mb-1">Rată Confirmare</h6>
                <h3 class="fw-bold mb-0 skeleton-text" id="statRate">...</h3>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="chart-container">
                <h5 class="fw-bold mb-4">Evoluție 2026</h5>
                <canvas id="mainChart" height="300"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-container">
                <h5 class="fw-bold mb-4">Status Comenzi</h5>
                <div style="height: 250px;"><canvas id="statusChart"></canvas></div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DashboardApp = {
        data: { appointments: [], services: [], priceMap: {} },
        charts: { main: null, status: null },

        init() {
            document.getElementById('sidebarToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('show'));
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ro-RO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            this.refreshData();
        },

        async refreshData() {
            this.toggleSkeleton(true);
            try {
                const [appRes, srvRes] = await Promise.all([fetch('/api/appointments'), fetch('/api/public/services')]);
                if(!appRes.ok || !srvRes.ok) throw new Error("API Error");

                this.data.appointments = await appRes.json();
                this.data.services = await srvRes.json();
                this.data.priceMap = this.data.services.reduce((acc, s) => { acc[s.numeServiciu] = s.pretServiciu || 0; return acc; }, {});

                this.renderStats();
            } catch(e) { console.error(e); }
            finally { this.toggleSkeleton(false); }
        },

        renderStats() {
            const apps = this.data.appointments;
            let revenue = 0, confirmed = 0;
            const statusCount = { NOU:0, CONFIRMAT:0, FINALIZAT:0, ANULAT:0 };
            const monthly = Array(12).fill(0);

            apps.forEach(a => {
                const st = a.status || 'NOU';
                statusCount[st] = (statusCount[st]||0) + 1;
                if(st === 'CONFIRMAT' || st === 'FINALIZAT') {
                    confirmed++;
                    revenue += (this.data.priceMap[a.serviceName] || 0);
                }
                const d = new Date(a.date);
                if(d.getFullYear() === new Date().getFullYear()) monthly[d.getMonth()]++;
            });

            document.getElementById('statTotal').textContent = apps.length;
            document.getElementById('statRevenue').textContent = revenue.toLocaleString() + " RON";
            document.getElementById('statServices').textContent = this.data.services.length;
            document.getElementById('statRate').textContent = apps.length ? Math.round((confirmed/apps.length)*100) + "%" : "0%";

            this.renderCharts(monthly, statusCount);
        },

        renderCharts(monthly, statusCount) {
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            if(this.charts.main) this.charts.main.destroy();
            this.charts.main = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Ian','Feb','Mar','Apr','Mai','Iun','Iul','Aug','Sep','Oct','Noi','Dec'],
                    datasets: [{ label: 'Programări', data: monthly, borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }]
                },
                options: { plugins: { legend: {display:false} }, scales: { y: {beginAtZero:true}, x: {grid:{display:false}} } }
            });

            const ctx2 = document.getElementById('statusChart').getContext('2d');
            if(this.charts.status) this.charts.status.destroy();
            this.charts.status = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Noi', 'Confirmate', 'Finalizate', 'Anulate'],
                    datasets: [{ data: [statusCount.NOU, statusCount.CONFIRMAT, statusCount.FINALIZAT, statusCount.ANULAT], backgroundColor: ['#f59e0b', '#4f46e5', '#10b981', '#ef4444'], borderWidth: 0 }]
                },
                options: { cutout: '75%', plugins: { legend: {position:'right', labels:{usePointStyle:true}} } }
            });
        },

        toggleSkeleton(show) {
            document.querySelectorAll('.skeleton-text').forEach(el => show ? el.classList.add('skeleton') : el.classList.remove('skeleton'));
        }
    };
    document.addEventListener('DOMContentLoaded', () => DashboardApp.init());
</script>
</body>
</html>
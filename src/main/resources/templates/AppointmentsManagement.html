<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Programări - Kineto Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --sidebar-width: 260px;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light); color: var(--dark); overflow-x: hidden; }

        /* Sidebar Copy Styles (Needed for consistent rendering) */
        .sidebar { width: var(--sidebar-width); background: #ffffff; border-right: 1px solid #e2e8f0; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; transition: margin-left 0.3s ease; }
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
        }

        /* Table & Cards */
        .card-custom { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); overflow: hidden; }
        .table thead th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; padding: 1rem; }
        .table tbody td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        .table-hover tbody tr:hover { background-color: #f8fafc; }

        /* Badges */
        .status-badge { padding: 0.35em 0.8em; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .bg-status-NOU { background-color: #fef3c7; color: #d97706; }
        .bg-status-CONFIRMAT { background-color: #e0e7ff; color: #4338ca; }
        .bg-status-FINALIZAT { background-color: #d1fae5; color: #059669; }
        .bg-status-ANULAT { background-color: #fee2e2; color: #dc2626; }

        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; color: transparent !important; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .toast-container { z-index: 2000; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white border-bottom d-lg-none sticky-top px-3">
    <a class="navbar-brand fw-bold text-primary" href="#"><i class="fas fa-spa me-2"></i>PhysioVanu</a>
    <button class="btn btn-light" id="sidebarToggle"><i class="fas fa-bars"></i></button>
</nav>

<nav th:replace="~{AdminDashboard :: sidebar('appointments')}"></nav>

<main class="main-content">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Gestionare Programări</h2>
            <p class="text-muted mb-0">Gestionează cererile și calendarul clienților.</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2">
            <button class="btn btn-white border shadow-sm" onclick="AppointmentsApp.exportCSV()">
                <i class="fas fa-file-csv text-success me-2"></i>Export CSV
            </button>
            <button class="btn btn-primary shadow-sm" onclick="AppointmentsApp.openModal()">
                <i class="fas fa-plus me-2"></i>Programare Nouă
            </button>
        </div>
    </div>

    <div class="card-custom p-3 mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Caută după nume sau telefon...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="ALL">Toate Statusurile</option>
                    <option value="NOU">Noi</option>
                    <option value="CONFIRMAT">Confirmate</option>
                    <option value="FINALIZAT">Finalizate</option>
                    <option value="ANULAT">Anulate</option>
                </select>
            </div>
            <div class="col-md-3 ms-auto d-flex align-items-center justify-content-end">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label small text-muted" for="autoRefresh">Live Updates</label>
                </div>
            </div>
        </div>
    </div>

    <div class="card-custom">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>Pacient</th>
                    <th>Serviciu</th>
                    <th>Data & Ora</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th class="text-end">Acțiuni</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr class="skeleton-row">
                    <td><div class="skeleton" style="width: 120px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 100px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 100px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 60px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 100px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 80px; height: 20px;"></div></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="emptyState" class="text-center py-5 d-none">
            <div class="bg-light rounded-circle d-inline-flex p-3 mb-3">
                <i class="fas fa-calendar-times fa-2x text-muted"></i>
            </div>
            <h6 class="text-muted">Nu au fost găsite programări.</h6>
        </div>
    </div>
</main>

<div class="modal fade" id="appModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">Programare Nouă</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="appForm">
                    <input type="hidden" id="appId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Nume Pacient</label>
                            <input type="text" class="form-control" id="appName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Telefon</label>
                            <input type="tel" class="form-control" id="appPhone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Serviciu</label>
                            <select class="form-select" id="appService" required>
                                <option value="" disabled selected>Se încarcă...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Data</label>
                            <input type="date" class="form-control" id="appDate" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Ora</label>
                            <input type="time" class="form-control" id="appTime" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Status</label>
                            <div class="d-flex gap-2">
                                <input type="radio" class="btn-check" name="status" id="st1" value="NOU" checked>
                                <label class="btn btn-outline-warning btn-sm" for="st1">Nou</label>
                                <input type="radio" class="btn-check" name="status" id="st2" value="CONFIRMAT">
                                <label class="btn btn-outline-primary btn-sm" for="st2">Confirmat</label>
                                <input type="radio" class="btn-check" name="status" id="st3" value="FINALIZAT">
                                <label class="btn btn-outline-success btn-sm" for="st3">Finalizat</label>
                                <input type="radio" class="btn-check" name="status" id="st4" value="ANULAT">
                                <label class="btn btn-outline-danger btn-sm" for="st4">Anulat</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Detalii Suplimentare</label>
                            <textarea class="form-control" id="appInfo" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0 pt-0 pb-4">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Anulează</button>
                <button type="button" class="btn btn-primary px-4" onclick="AppointmentsApp.save()">Salvează</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMsg"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const AppointmentsApp = {
        data: { list: [], services: [] },
        interval: null,
        modal: null,
        toast: null,

        init() {
            // Sidebar Mobile Toggle
            const toggle = document.getElementById('sidebarToggle');
            if(toggle) toggle.addEventListener('click', () => document.getElementById('sidebar').classList.toggle('show'));

            this.modal = new bootstrap.Modal(document.getElementById('appModal'));
            this.toast = new bootstrap.Toast(document.getElementById('liveToast'));

            // Load Initial Data
            this.loadServices();
            this.loadAppointments();

            // Setup Listeners
            document.getElementById('searchInput').addEventListener('input', () => this.render());
            document.getElementById('statusFilter').addEventListener('change', () => this.render());
            document.getElementById('autoRefresh').addEventListener('change', (e) => {
                if(e.target.checked) this.startPolling(); else this.stopPolling();
            });

            this.startPolling();
        },

        async loadServices() {
            try {
                const res = await fetch('/api/public/services');
                this.data.services = await res.json();
                const select = document.getElementById('appService');
                select.innerHTML = '<option value="" disabled selected>Alege serviciu</option>';
                this.data.services.forEach(s => {
                    select.innerHTML += `<option value="${s.numeServiciu}">${s.numeServiciu} (${s.pretServiciu} RON)</option>`;
                });
            } catch(e) { console.error("Err services", e); }
        },

        async loadAppointments() {
            try {
                const res = await fetch('/api/appointments');
                const newData = await res.json();
                // Simple check to avoid re-rendering if data hasn't changed (optional optimization)
                if(JSON.stringify(newData) !== JSON.stringify(this.data.list)) {
                    this.data.list = newData;
                    this.render();
                }
            } catch(e) { console.error("Err appointments", e); }
        },

        render() {
            const container = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('statusFilter').value;

            const filtered = this.data.list.filter(app => {
                const matchesSearch = (app.patientName||'').toLowerCase().includes(search) || (app.phoneNumber||'').includes(search);
                const matchesFilter = filter === 'ALL' || app.status === filter;
                return matchesSearch && matchesFilter;
            });

            if(filtered.length === 0) {
                container.innerHTML = '';
                document.getElementById('emptyState').classList.remove('d-none');
                return;
            }

            document.getElementById('emptyState').classList.add('d-none');

            // Sort by Date Descending
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = filtered.map(app => `
                <tr>
                    <td>
                        <div class="fw-bold text-dark">${app.patientName}</div>
                        <small class="text-muted" style="font-size:0.75rem">ID: #${app.id}</small>
                    </td>
                    <td><span class="fw-medium text-primary">${app.serviceName || 'N/A'}</span></td>
                    <td>
                        <div><i class="far fa-calendar me-1 text-muted"></i> ${app.date}</div>
                        <small class="text-muted"><i class="far fa-clock me-1"></i> ${app.time}</small>
                    </td>
                    <td><span class="status-badge bg-status-${app.status}">${app.status}</span></td>
                    <td><a href="tel:${app.phoneNumber}" class="text-decoration-none text-dark"><i class="fas fa-phone-alt me-1 text-success"></i>${app.phoneNumber}</a></td>
                    <td class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-white border" onclick="AppointmentsApp.edit(${app.id})"><i class="fas fa-edit text-primary"></i></button>
                            <button class="btn btn-sm btn-white border" onclick="AppointmentsApp.delete(${app.id})"><i class="fas fa-trash text-danger"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        },

        openModal() {
            document.getElementById('appForm').reset();
            document.getElementById('appId').value = '';
            document.getElementById('modalTitle').textContent = 'Programare Nouă';
            // Set default date today
            document.getElementById('appDate').value = new Date().toISOString().split('T')[0];
            this.modal.show();
        },

        edit(id) {
            const app = this.data.list.find(a => a.id === id);
            if(!app) return;

            document.getElementById('appId').value = app.id;
            document.getElementById('appName').value = app.patientName;
            document.getElementById('appPhone').value = app.phoneNumber;
            document.getElementById('appService').value = app.serviceName;
            document.getElementById('appDate').value = app.date;
            document.getElementById('appTime').value = app.time;
            document.getElementById('appInfo').value = app.additionalInfo || '';

            // Radio button selection
            const radios = document.getElementsByName('status');
            radios.forEach(r => { if(r.value === app.status) r.checked = true; });

            document.getElementById('modalTitle').textContent = 'Editează Programare';
            this.modal.show();
        },

        async save() {
            const id = document.getElementById('appId').value;
            const status = document.querySelector('input[name="status"]:checked').value;

            const payload = {
                id: id ? id : null,
                patientName: document.getElementById('appName').value,
                phoneNumber: document.getElementById('appPhone').value,
                serviceName: document.getElementById('appService').value,
                date: document.getElementById('appDate').value,
                time: document.getElementById('appTime').value,
                status: status,
                additionalInfo: document.getElementById('appInfo').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/appointments/${id}` : '/api/appointments';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(!res.ok) throw new Error("Eroare salvare");

                this.modal.hide();
                this.showToast(id ? 'Actualizat cu succes!' : 'Creat cu succes!', 'success');
                this.loadAppointments();
            } catch(e) {
                alert("Eroare la salvare: " + e.message);
            }
        },

        async delete(id) {
            if(!confirm("Sigur ștergi această programare?")) return;
            try {
                await fetch(`/api/appointments/${id}`, { method: 'DELETE' });
                this.showToast('Programare ștearsă.', 'danger');
                this.loadAppointments();
            } catch(e) { alert("Eroare la ștergere"); }
        },

        exportCSV() {
            let csv = "ID,Nume,Telefon,Serviciu,Data,Ora,Status,Info\n";
            this.data.list.forEach(row => {
                const info = (row.additionalInfo || '').replace(/[\n,]/g, ' ');
                csv += `${row.id},${row.patientName},${row.phoneNumber},${row.serviceName},${row.date},${row.time},${row.status},${info}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'programari.csv';
            a.click();
        },

        startPolling() {
            if(!this.interval) this.interval = setInterval(() => this.loadAppointments(), 10000);
        },
        stopPolling() {
            clearInterval(this.interval);
            this.interval = null;
        },

        showToast(msg, type) {
            const toastEl = document.getElementById('liveToast');
            document.getElementById('toastMsg').textContent = msg;
            toastEl.className = `toast align-items-center text-white border-0 bg-${type === 'success' ? 'success' : 'danger'}`;
            this.toast.show();
        }
    };

    document.addEventListener('DOMContentLoaded', () => AppointmentsApp.init());
</script>
</body>
</html>